<!DOCTYPE html><html lang="en-US">
<!-- Mirrored from bholmes.dev/blog/mocking-browser-apis-fetch-localstorage-dates-the-easy-way-with-jest/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 16 Mar 2022 05:57:18 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head><link rel="stylesheet" href="__styles.html"><link rel="stylesheet" href=../../_layouts/__styles.css><link rel="stylesheet" href=../../_layouts/blog-post/__styles.css><title>Mocking browser APIs in Jest (localStorage, fetch and more!)</title><link rel="preload" href="https://use.typekit.net/liz3dnm.css" as="style"/><link rel="preload" href="../../assets/fonts/Atkinson/Atkinson-Hyperlegible-Regular.woff2" as="font" crossorigin="anonymous"/><link rel="preload" href="../../assets/fonts/Atkinson/Atkinson-Hyperlegible-Bold.woff2" as="font" crossorigin="anonymous"/><link rel="preload" href="../../assets/fonts/Atkinson/Atkinson-Hyperlegible-Italic.woff2" as="font" crossorigin="anonymous"/><link rel="preload" href="../../assets/fonts/Atkinson/Atkinson-Hyperlegible-BoldItalic.woff2" as="font" crossorigin="anonymous"/><link rel="stylesheet" href="https://use.typekit.net/liz3dnm.css"/><link rel="icon" type="img/jpg" href="../../assets/favicon.jpg"/><link rel="canonical" href="index.html"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><!-- TODO: automatically generate these at buildtime--><link rel="modulepreload" href="__client.html"/><link rel="modulepreload" href="__data.html"/><link rel="modulepreload" href="../../_layouts/__client.mjs"/><link rel="modulepreload" href="../../_layouts/__data.mjs"/><link rel="preload" as="fetch" href="../../index-2.html"/><link rel="preload" as="fetch" href="../../work/index.html"/><link rel="preload" as="fetch" href="../../contact/index.html"/><meta name="author" content="Ben Holmes"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@bholmesdev"/><meta name="twitter:creator" content="@bholmesdev"/><meta name="description" content="Turns out, Jest gives you access to all sorts of browser APIs (fetch, localStorage, etc) that you can mock at a moment's notice! Let's see how."/><meta property="og:url" content="index.html"/><meta property="og:image" content="https://raw.githubusercontent.com/Holben888/personal-blog/main/mocking-global-in-jest/thumbnail.png"/><meta property="og:image:width" content="1200"/><meta property="og:image:height" content="630"/><meta property="og:site_name" content="Ben Holmes"/><meta property="og:title" content="Mocking browser APIs in Jest (localStorage, fetch and more!)"/><meta property="og:description" content="Turns out, Jest gives you access to all sorts of browser APIs (fetch, localStorage, etc) that you can mock at a moment's notice! Let's see how."/><!-- Analytics--><script async="async" defer="defer" data-domain="bholmes.dev" src="https://stats.bholmes.dev/js/index.js"></script></head><body><div id="loading-spinner" aria-label="loading"><div class="loading-spinner__graphic"><div class="loading-spinner__graphic--dash"></div><div class="loading-spinner__graphic--dash"></div><div class="loading-spinner__graphic--dash"></div></div></div><nav id="site-navigation"><div class="jump-to-section__container"><button id="jump-to-section__toggle" aria-label="Reveal table of contents"><span>0</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M128 192l128 128 128-128z"/></svg></button><div class="jump-to-section__label-container"><p id="jump-to-section__label"></p></div><ul id="jump-to-section__links"></ul></div><div class="primary-nav__container"><ul id="primary-nav__links"><li><a href="../../index.html">Ben</a></li><li><a class="active" href="../index.html">Blog</a></li><li><a href="../../work/index-2.html">Works</a></li><li><a href="../../contact/index-2.html">Contact</a></li></ul><button id="primary-nav__toggle" aria-label="Reveal navigation links"><div class="stripe-top"></div><div class="stripe-middle"></div><div class="stripe-bottom"></div></button></div></nav><div id="loading-spinner" aria-label="loading"><div class="loading-spinner__graphic"><div class="loading-spinner__graphic--dash"></div><div class="loading-spinner__graphic--dash"></div><div class="loading-spinner__graphic--dash"></div></div></div><div data-page="_layouts/blog-post"><main><article data-page="blog/mocking-browser-apis-fetch-localstorage-dates-the-easy-way-with-jest"><header><picture><source type="image/webp" srcset="/assets/pug-images/943aa839-600.webp 600w, /assets/pug-images/943aa839-800.webp 800w, /assets/pug-images/943aa839-1400.webp 1400w" sizes="(min-width: 800px) 720px, 100vw"><source type="image/jpeg" srcset="/assets/pug-images/943aa839-600.jpeg 600w, /assets/pug-images/943aa839-800.jpeg 800w, /assets/pug-images/943aa839-1400.jpeg 1400w" sizes="(min-width: 800px) 720px, 100vw"><img alt="Turns out, Jest gives you access to all sorts of browser APIs (fetch, localStorage, etc) that you can mock at a moment's notice! Let's see how." loading="lazy" decoding="async" widths="800,1000,1400" src="../../assets/pug-images/943aa839-600.jpg" width="1400" height="587"></picture><h1>Mocking browser APIs in Jest (localStorage, fetch and more!)</h1><p class="details"><span><strong>6</strong> minute read</span><span class="spacer">•</span><span>Last updated <time pubdate="pubdate" datetime="2021-01-19T22:48:29.682Z">January 19, 2021</time></span></p></header><div><p>I hit a snag recently trying to test a <code>localStorage</code> helper written in React. Figuring out how to test all my state and render changes was certainly the easy part (thanks as always <a href="https://github.com/testing-library/react-testing-library" target="_blank" rel="noreferrer">React Testing Library</a> 🐐).</p>
<p>But soon, I found myself wondering... is there an easy way to &quot;mock&quot; a browser API like storage? Or better yet, how should I test <strong>any function using X API?</strong></p>
<p>Well, hope you're hungry! We're gonna explore</p>
<ul>
<li>🚅 Why dependency injection doesn't feel like a silver bullet</li>
<li>📦 How we can mock <code>localStorage</code> using the <code>global</code> object</li>
<li>📶 Ways to go further mocking the <code>fetch</code> API</li>
<li>🔎 An alternative approach using <code>jest.spyOn</code></li>
</ul>
<p><em>Onwards!</em></p>
<h2 id="link-lets-grab-something-to-eat-first">Let's grab something to eat first</h2>
<p>Here's a simple (and tasty) example of a function worth testing:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">saveForLater</span><span class="token punctuation">(</span><span class="token parameter">leftoverChili</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> whatsInTheFridge <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'mealPrepOfTheWeek'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>whatsInTheFridge <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// if our fridge is empty, chili's on the menu 🌶</span>
     	localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'mealPrepOfTheWeek'</span><span class="token punctuation">,</span> leftoverChili<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// otherwise, we'll just bring it to our neighbor's potluck 🍽</span>
      <span class="token function">goToPotluck</span><span class="token punctuation">(</span>leftoverChili<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token comment">// if something went wrong, we're going to the potluck empty-handed 😬</span>
    <span class="token function">goToPotluck</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is pretty straightforward... but it's got some <code>localStorage</code> madness baked-in. We could probably start with the <strong>inject all the things strategy (TM)</strong> to address this:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">saveForLater</span><span class="token punctuation">(</span>leftoverChili<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// treat our storage calls as parameters to the function,</span>
  <span class="token comment">// with the default value set to our desired behavior</span>
  getFromStorage <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'mealPrepOfTheWeek'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">setInStorage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token operator">=></span> localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'mealPrepOfTheWeek'</span><span class="token punctuation">,</span> food<span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// then, sub these values into our function</span>
    <span class="token keyword">const</span> whatsInTheFridge <span class="token operator">=</span> <span class="token function">getFromStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token function">setInStorage</span><span class="token punctuation">(</span>leftoverChili<span class="token punctuation">)</span>
		<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then, our test file can pass some tasty mock functions we can work with:</p>
<pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'puts the chili in the fridge when the fridge is empty'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// just make some dummy functions, where the getter returns undefined</span>
  <span class="token keyword">const</span> getFromStorage <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
  <span class="token comment">// then, make a mock storage object to check</span>
  <span class="token comment">// whether the chili was put in the fridge</span>
  <span class="token keyword">let</span> mockStorage
  <span class="token keyword">const</span> setInStorage <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span> mockStorage <span class="token operator">=</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
	<span class="token function">saveForLater</span><span class="token punctuation">(</span><span class="token string">'chili'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> getFromStorage<span class="token punctuation">,</span> setInStorage <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>setInStorage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockFridge<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'chili'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>This isn't <em>too</em> bad. Now we can check whether our <code>localStorage</code> functions get called, and verify that we're sending the right values.</p>
<p>Still, there's something a bit ugly here: <strong>we just restructured our code for the sake of cleaner tests!</strong> I don't know about you, but I feel a little uneasy moving the internals of my function to a set of <em>parameters</em>. And what if the unit tests move away or get rewritten years down the line? That leaves us with another odd design choice to pass onto the next developer 😕</p>
<h2 id="link-what-if-we-could-mock-browser-storage-directly">📦 What if we could mock browser storage directly?</h2>
<p>Sure, <a href="https://stackoverflow.com/questions/45111198/how-to-mock-functions-in-the-same-module-using-jest" target="_blank" rel="noreferrer">mocking module functions <em>we wrote ourselves</em> is pretty tough.</a> But mocking native APIs is surprisingly straightforward! Let me stir the pot a little 🥘</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// let's make a mock fridge (storage) for all our tests to use</span>
<span class="token keyword">let</span> mockFridge <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  global<span class="token punctuation">.</span><span class="token class-name">Storage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setItem <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    mockFridge<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  global<span class="token punctuation">.</span><span class="token class-name">Storage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getItem <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> mockFridge<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// make sure the fridge starts out empty for each test</span>
  mockFridge <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// return our mocks to their original values</span>
  <span class="token comment">// 🚨 THIS IS VERY IMPORTANT to avoid polluting future tests!</span>
	global<span class="token punctuation">.</span><span class="token class-name">Storage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setItem<span class="token punctuation">.</span><span class="token function">mockReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  global<span class="token punctuation">.</span><span class="token class-name">Storage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>getItem<span class="token punctuation">.</span><span class="token function">mockReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Oh, take a look at that meaty piece in the middle! There's some big takeaways from this:</p>
<ol>
<li><strong>Jest gives you a nice <code>global</code> object to work with.</strong> More specifically, Jest gives you access to <a href="https://github.com/jsdom/jsdom" target="_blank" rel="noreferrer">JSDOM</a> out-of-the-box, which populates <code>global</code> (a standard in Node) with a treasure trove of APIs. As we've discovered, it includes our favorite browser APIs as well!</li>
<li><strong>We can use the <code>prototype</code> to mock functions inside a JS class.</strong> You're right to wonder <em>why</em> we need to mock <code>Storage.prototype</code>, rather than mocking <code>localStorage</code> directly. In short: <code>localStorage</code> is actually an <em>instance</em> of a Storage <em>class.</em> Sadly, mocking methods on a class instance (i.e. <code>localStorage.getItem</code>) doesn't work with our <code>jest.fn</code> approach. But don't fret! You can <a href="https://stackoverflow.com/a/41434763" target="_blank" rel="noreferrer">mock the entire <code>localStorage</code> class</a> as well if this <code>prototype</code> madness makes you feel uneasy 😁 Fair warning though: it's a bit harder to test whether class methods were called with <code>toHaveBeenCalled</code> compared to a plan ole' <code>jest.fn</code>.</li>
</ol>
<p>💡 <em><strong>Note:</strong> This strategy will mock both <code>localStorage</code> and <code>sessionStorage</code> with the same set of functions. If you need to mock these independently, you might need to split up your test suites or <a href="https://stackoverflow.com/a/41434763" target="_blank" rel="noreferrer">mock the storage class</a> as previously suggested.</em></p>
<p>Now, we're good to test our original function injection-free!</p>
<pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'puts the chili in the fridge when the fridge is empty'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
	<span class="token function">saveForLater</span><span class="token punctuation">(</span><span class="token string">'chili'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span><span class="token class-name">Storage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>setItem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mockStorage<span class="token punctuation">[</span><span class="token string">'mealPrepOfTheWeek'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token string">'chili'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>There's almost no setup to speak of now that we're mocking <code>global</code> values. <strong>Just remember to clean the kitchen in that <code>afterAll</code> block,</strong> and we're good to go 👍</p>
<h2 id="link-so-what-else-could-we-mock">📶 So what else could we mock?</h2>
<p>Now that we're cooking with crisco, let's try our hand at some more <code>global</code> functions. <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" target="_blank" rel="noreferrer"><strong>The <code>fetch</code> API</strong></a> is a great candidate for this:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// let's fetch some ingredients from the store</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">grabSomeIngredients</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
  	<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://wholefoods.com/overpriced-organic-spices'</span><span class="token punctuation">)</span>
  	<span class="token keyword">const</span> <span class="token punctuation">{</span> cumin<span class="token punctuation">,</span> paprika<span class="token punctuation">,</span> chiliPowder <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span>cumin<span class="token punctuation">,</span> paprika<span class="token punctuation">,</span> chiliPowder<span class="token punctuation">]</span> 
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Seems simple enough! We're just making sure that the Cumin, Paprika, and Chili Powder get fetched and returned in an array of chili spices 🌶</p>
<p>As you might expect, we're using the same <code>global</code> strategy as before:</p>
<pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'fetches the right ingredients'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cumin <span class="token operator">=</span> <span class="token string">'McCormick ground cumin'</span>
  <span class="token keyword">const</span> paprika <span class="token operator">=</span> <span class="token string">'Smoked paprika'</span>
  <span class="token keyword">const</span> chiliPowder <span class="token operator">=</span> <span class="token string">'Spice Islands Chili Powder'</span>
  <span class="token keyword">let</span> spices <span class="token operator">=</span> <span class="token punctuation">{</span> cumin<span class="token punctuation">,</span> paprika<span class="token punctuation">,</span> chiliPowder<span class="token punctuation">,</span> garlicSalt<span class="token operator">:</span> <span class="token string">'Yuck. Fresh garlic only!'</span> <span class="token punctuation">}</span>
  
  global<span class="token punctuation">.</span>fetch <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementationOnce</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// first, mock the "json" function containing our result</span>
        <span class="token function-variable function">json</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token comment">// then, resolve this second promise with our spices</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>spices<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">grabSomeIngredients</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span>cumin<span class="token punctuation">,</span> paprika<span class="token punctuation">,</span> chiliPowder<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Not too bad! You'll probably need a second to process that doubly-nested <code>Promise</code> we're mocking (remember, <code>fetch</code> returns <em>another</em> promise for the <code>json</code> result!). Still, our test stayed pretty lean while thoroughly testing our function.</p>
<p>You'll also notice that we used <strong><code>mockImplementationOnce</code></strong> here. Sure, we could have used the same <code>beforeAll</code> technique as before, but we probably want to mock different implementations for <code>fetch</code> once we get into the error scenarios. Here's how that might look:</p>
<pre class="language-js"><code class="language-js"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'returns an empty array on bad fetch'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    global<span class="token punctuation">.</span>fetch <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementationOnce</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// if our fetch fails, we don't get any spices!</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'returns an empty array on bad json format'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    global<span class="token punctuation">.</span>fetch <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementationOnce</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token function-variable function">json</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>And since we're mocking implementation <em>once,</em> there's no <code>afterAll</code> cleanup to worry about! Pays to clean your dishes as soon as you're done with them 🧽</p>
<h2 id="link-addendum-using-spies">🔎 Addendum: using &quot;spies&quot;</h2>
<p>Before wrapping up, I want to point out an alternative approach: mocking <code>global</code> using <a href="https://jestjs.io/docs/en/jest-object#jestspyonobject-methodname" target="_blank" rel="noreferrer">Jest spies</a>.</p>
<p>Let's refactor our <code>localStorage</code> example from before:</p>
<pre class="language-js"><code class="language-js"><span class="token operator">...</span>
<span class="token comment">// first, we'll need to make some variables to hold onto our spies</span>
<span class="token comment">// we'll use these for clean-up later</span>
<span class="token keyword">let</span> setItemSpy<span class="token punctuation">,</span> getItemSpy

<span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// previously: global.Storage.prototype.setItem = jest.fn(...)</span>
	setItemSpy <span class="token operator">=</span> jest
    <span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span><span class="token class-name">Storage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'setItem'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      mockStorage<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// previously: global.Storage.prototype.getItem = jest.fn(...)</span>
  getItemSpy <span class="token operator">=</span> jest
    <span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>global<span class="token punctuation">.</span><span class="token class-name">Storage</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'getItem'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=></span> mockStorage<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// then, detach our spies to avoid breaking other test suites</span>
  getItemSpy<span class="token punctuation">.</span><span class="token function">mockRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  setItemSpy<span class="token punctuation">.</span><span class="token function">mockRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Overall, this is pretty much identical to our original approach. The only difference is in the semantics; instead of <strong>assigning new behavior</strong> to these global functions (i.e. <code>= jest.fn()</code>), we're <strong>intercepting requests to these functions</strong> and using our own implementation.</p>
<p>This might feel a little &quot;safer&quot; to some people, since we're not explicitly overwriting the behavior of these functions anymore. But as long as you pay attention to your cleanup in the <code>afterAll</code> block, either approach is valid 😁</p>
</div><hr/><footer><p>Learn a little something? <strong><a href="https://twitter.com/intent/tweet?text=Woah,%20I%20learned%20so%20much%20from%20this!%20%22Mocking%20browser%20APIs%20in%20Jest%20(localStorage,%20fetch%20and%20more!)%22%20by%20@bholmesdev%20https://bholmes.dev/blog/mocking-browser-apis-fetch-localstorage-dates-the-easy-way-with-jest/" target="_blank" rel="noreferrer">Share this post</a> on Twitter!</strong></p><section class="about-the-author"><img src="../../assets/images/me.jpg" alt="Hand drawn portrait of Ben Holmes"/><div><address><a rel="author" href="../../index.html">Ben Holmes </a></address>is a web developer + UI designer by trade from Charleston SC. He's been tinkering with JavaScript and CSS since 2014, and has lead a <a href="https://hack4impact.org/dev-bootcamp">full stack bootcamp curriculum</a> used by universities across the country. Now, he's working fulltime at Peloton and teaching the world a bit of web whimsy in his spare time.</div></section></footer></article></main><footer><div class="content"><div class="newsletter"><h2>Woah, there's a newsletter too!</h2><form action="https://tinyletter.com/bholmesdev" method="post" target="_blank"><label for="email">Email</label><input id="email" type="email" name="email" placeholder="10xengineer@genius.club" required="required"/><p class="newsletter__never-spam">Don't worry, I won't spam you</p><button class="cta-link" type="submit">Yes please, more content<svg xmlns="http://www.w3.org/2000/svg" fill="#5f4b32" width="34" height="34" viewBox="0 0 512 512"><path d="M48 270.9l118.9 44.6L181.7 464 256 360l104 104L464 48 48 270.9zm294.9 126L260 313.4 374.9 152 193.6 289.8 124.9 265l291-156.2-73 288.1z"/></svg></svg></button></form></div><div class="socials"><div class="socials__links"><a href="https://dev.to/bholmesdev" target="_blank" rel="noreferrer" aria-label="Ben's DEV.to blog"><svg xmlns="http://www.w3.org/2000/svg" fill="#5f4b32" width="34" height="34" viewBox="0 0 34 34"><path d="M18.119,22.38a1.48,1.48,0,0,0-.881-.33H15.917v7.929h1.321a1.449,1.449,0,0,0,.881-.33,1.172,1.172,0,0,0,.44-.991V23.371a1.172,1.172,0,0,0-.44-.991ZM39.669,9H12.331A3.332,3.332,0,0,0,9,12.324V39.676A3.332,3.332,0,0,0,12.331,43H39.669A3.332,3.332,0,0,0,43,39.676V12.324A3.332,3.332,0,0,0,39.669,9ZM20.7,28.67a3.466,3.466,0,0,1-3.668,3.586H13.508V19.7H17.1a3.462,3.462,0,0,1,3.593,3.586L20.7,28.67Zm7.647-6.731H24.3v2.918h2.471V27.1H24.3v2.918h4.047v2.244H23.626a1.531,1.531,0,0,1-1.569-1.494v-9.5A1.531,1.531,0,0,1,23.55,19.7h4.8v2.237Zm7.86,8.755c-1,2.333-2.794,1.872-3.6,0L29.682,19.7h2.471l2.257,8.631L36.654,19.7h2.471L36.207,30.694Z" transform="translate(-9 -9)"/></svg></a><a href="https://twitter.com/bholmesdev" target="_blank" rel="noreferrer" aria-label="Ben's Twitter"><svg xmlns="http://www.w3.org/2000/svg" fill="#5f4b32" width="34" height="34" viewBox="0 0 34 34"><path d="M55.383,67.4a14.634,14.634,0,0,1-4.157,1.144,7.264,7.264,0,0,0,3.185-4.008,14.384,14.384,0,0,1-4.6,1.757,7.237,7.237,0,0,0-12.524,4.95,7.087,7.087,0,0,0,.187,1.652,20.514,20.514,0,0,1-14.924-7.574A7.253,7.253,0,0,0,24.8,75a7.07,7.07,0,0,1-3.29-.9v.09a7.245,7.245,0,0,0,5.809,7.1,7.287,7.287,0,0,1-1.907.254,6.829,6.829,0,0,1-1.361-.135,7.25,7.25,0,0,0,6.766,5.032,14.513,14.513,0,0,1-8.995,3.1,14.673,14.673,0,0,1-1.727-.1,20.234,20.234,0,0,0,11.081,3.275c13.331,0,20.613-11.043,20.613-20.621,0-.314-.007-.628-.022-.935A14.736,14.736,0,0,0,55.383,67.4Z" transform="translate(-20.1 -64)"/></svg></a><a href="https://github.com/holben888" target="_blank" rel="noreferrer" aria-label="Ben's GitHub"><svg xmlns="http://www.w3.org/2000/svg" fill="#5f4b32" width="34" height="34" viewBox="0 0 34 34"><path d="M10,115.987a18.6,18.6,0,0,0,.434,4.181,12.443,12.443,0,0,0,1.2,3.251,9.207,9.207,0,0,0,1.943,2.429,11.2,11.2,0,0,0,2.56,1.714,15.1,15.1,0,0,0,3.15,1.079,26,26,0,0,0,3.615.583q1.847.167,4.056.167,2.227,0,4.073-.167a26.227,26.227,0,0,0,3.626-.583,15.681,15.681,0,0,0,3.168-1.079,11.191,11.191,0,0,0,2.578-1.714,9.284,9.284,0,0,0,1.964-2.429,12.2,12.2,0,0,0,1.2-3.251A18.6,18.6,0,0,0,44,115.987a10.2,10.2,0,0,0-2.758-7.133,8.923,8.923,0,0,0,.274-.906,12.4,12.4,0,0,0,.232-1.447,8.1,8.1,0,0,0-.083-2.168,11.516,11.516,0,0,0-.708-2.512l-.25-.049a3.352,3.352,0,0,0-.874.024,9.708,9.708,0,0,0-1.412.3,12.073,12.073,0,0,0-2.078.864,24.135,24.135,0,0,0-2.685,1.6,26.284,26.284,0,0,0-6.668-.666,26.208,26.208,0,0,0-6.651.666,22.6,22.6,0,0,0-2.7-1.6,13.381,13.381,0,0,0-2.054-.864,8.05,8.05,0,0,0-1.429-.291,4.676,4.676,0,0,0-.84-.042,1.455,1.455,0,0,0-.274.059,11.462,11.462,0,0,0-.708,2.512,8.1,8.1,0,0,0-.083,2.168,12.664,12.664,0,0,0,.232,1.447,8.922,8.922,0,0,0,.274.906A10.223,10.223,0,0,0,10,115.987Zm4.174,4.174a5.879,5.879,0,0,1,2.179-4.389,4.334,4.334,0,0,1,1.513-.906,6.575,6.575,0,0,1,1.953-.347c.725-.028,1.422-.021,2.085.017s1.485.09,2.46.156,1.818.1,2.526.1,1.551-.031,2.529-.1,1.8-.118,2.46-.156,1.36-.045,2.085-.017a6.687,6.687,0,0,1,1.953.347,4.366,4.366,0,0,1,1.513.906,5.814,5.814,0,0,1,2.179,4.389,8.215,8.215,0,0,1-.357,2.536,6.367,6.367,0,0,1-.912,1.853,4.535,4.535,0,0,1-1.547,1.273,10.782,10.782,0,0,1-1.929.8,13.909,13.909,0,0,1-2.411.441c-.982.1-1.856.17-2.626.191s-1.749.035-2.935.035-2.165-.01-2.935-.035-1.644-.087-2.626-.191a13.648,13.648,0,0,1-2.411-.441,11.153,11.153,0,0,1-1.929-.8,4.535,4.535,0,0,1-1.547-1.273,6.414,6.414,0,0,1-.916-1.853A8.438,8.438,0,0,1,14.174,120.161Zm17.076-.333c0,1.759.951,3.188,2.127,3.188s2.127-1.426,2.127-3.188-.951-3.188-2.127-3.188S31.25,118.066,31.25,119.828Zm-12.75,0c0,1.759.951,3.188,2.127,3.188s2.127-1.426,2.127-3.188-.951-3.188-2.127-3.188S18.5,118.066,18.5,119.828Z" transform="translate(-10 -101.754)"/></svg></a></div><p>Follow along with <strong>Ben</strong> for the fun, for the whimsy, and for the love of building websites ♥ </p></div></div></footer></div></body>
          <script src="../../__main.mjs" defer></script>
          
          
<!-- Mirrored from bholmes.dev/blog/mocking-browser-apis-fetch-localstorage-dates-the-easy-way-with-jest/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 16 Mar 2022 05:57:22 GMT -->
</html>